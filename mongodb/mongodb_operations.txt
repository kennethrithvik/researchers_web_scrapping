//ad ids to all publications
db.researchers.find({})
  .forEach(function (doc) {
    doc.publications.forEach(function (publication) {
      publication._id=new ObjectId()
    });
    db.researchers_copy.save(doc);
});


//create new publication collection
db.researchers_copy.find().forEach(function(doc){
    db.test.insert(doc.publications)
});

//create publications collection 
db.singapore_researchers_copy.aggregate([
    {$unwind:'$publications'       
    },
    {$project:{_id:0,user_id:1,name:1,organisation:1,companies:1,person_url:1,schools:1,
                edits:1,grants:1,awards:1,publications:1,research_areas:1,keywords:1,
                tel_no:1,email:1,patents:1
               }
    },
    {$out:"publications"
    }
])

//create index for publications
db.publications.createIndex({"publications.year":1})

//get no. of publications in each year
db.publications.aggregate(
    [
    {$group:{_id:"$publications.year",my_count:{$sum:1}}},
    {$sort:{_id:1}}
    ]
)


//embed author into publications
db.publications.aggregate([
    {$lookup:
        {
            from:'singapore_researchers_copy',
            localField: 'author_id',
            foreignField: '_id',
            as: "author"
        }       
    },
    {$unwind:'$author'       
     }
])












//schema
extract-mongo-schema -d "mongodb://localhost:27017/research" -o schema.json -f json