//ad ids to all publications
db.singapore_researchers.find({})
  .forEach(function (doc) {
    doc.publications.forEach(function (publication) {
      publication._id=new ObjectId()
    });
    db.singapore_researchers.save(doc);
});


//create new publication collection
db.singapore_researchers.find().forEach(function(doc){
    db.singapore_publication.insert(doc.publications)
});

//create publications collection 
db.singapore_researchers.aggregate([
    {$unwind:'$publications'       
    },
    {$project:{_id:0,author_name:"$publications.author",organisation:1,title:"$publications.title",author_id:"$_id",
        year:"$publications.year",journal:"$publications.journal",vol_page:"$publications.vol:page"
               }
    },
    {$out:"singapore_publications"
    }
])

//create index for publications
db.singapore_publications.createIndex({"publications.year":1})

//get no. of publications in each year
db.singapore_publications.aggregate(
    [
    {$group:{_id:"$publications.year",my_count:{$sum:1}}},
    {$sort:{_id:1}}
    ]
)


//embed author into publications
db.singapore_publications.aggregate([
    {$lookup:
        {
            from:'singapore_researchers',
            localField: 'author_id',
            foreignField: '_id',
            as: "author"
        }       
    },
    {$unwind:'$author'       
     }
])












//schema
extract-mongo-schema -d "mongodb://localhost:27017/research" -o schema.json -f json
